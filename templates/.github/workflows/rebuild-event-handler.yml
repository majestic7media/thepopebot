name: Rebuild Event Handler

on:
  push:
    branches: [main]

concurrency:
  group: deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Deploy event handler
        run: |
          docker exec thepopebot-event-handler bash -c '
            # Load GH_TOKEN and authenticate git via GitHub CLI
            export GH_TOKEN=$(grep "^GH_TOKEN=" /app/.env | cut -d= -f2-)
            echo "${GH_TOKEN}" | gh auth login --with-token
            gh auth setup-git

            # Check if there are code changes (not just logs)
            git fetch origin main
            CHANGED=$(git diff --name-only HEAD origin/main)
            if ! echo "$CHANGED" | grep -qv "^logs/"; then
              echo "Logs-only change, skipping rebuild"
              git reset --hard origin/main
              exit 0
            fi

            # Pull latest code and install dependencies
            git reset --hard origin/main
            npm install --omit=dev

            # Clean build to a separate directory (no stale cache)
            rm -rf .next-new .next-old
            NEXT_BUILD_DIR=.next-new npm run build

            # Atomic swap: old .next keeps serving until pm2 reload
            mv .next .next-old 2>/dev/null || true
            mv .next-new .next

            echo "Rebuild complete, reloading Next.js..."
            npx pm2 reload all

            # Cleanup
            rm -rf .next-old
          '
